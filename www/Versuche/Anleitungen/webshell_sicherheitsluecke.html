<h3 id="behebung-der-sicherheitsl√ºcke">Behebung der
Sicherheitsl√ºcke</h3>
<p>üõ†Ô∏è <strong>(Perspektive: Serveradministrator/-in)</strong></p>
<p>Im finalen Schritt dieser √úbung wechseln Sie in die Rolle eines/r
Serveradministrator/-in.</p>
<p>Wichtig ist es, dass die hier gezeigten Ma√ünahmen unvollst√§ndig sind
um einen ausreichenden Schutz gegen√ºber dieser Sicherheitsl√ºcke zu
gew√§hren. Die Ma√ünahmen sind jedoch ausreichend f√ºr den Anwendungsfall
dieser √úbung.</p>
<ol type="1">
<li><p><strong>Ma√ünahme</strong></p>
<p>Erstellen Sie eine .htaccess Datei mit unten angef√ºhrtem Inhalt</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nano</span> /var/www/html/public/uploads/images/.htaccess</span></code></pre></div>
<p>Inhalt der .htaccess Datei:</p>
<pre><code>RemoveHandler .php .phtml .php3
RemoveType .php .phtml .php3
php_flag engine off</code></pre>
<p>Die htaccess Datei ist eine Konfigurationsdatei f√ºr einen Apache
Server. Sie enth√§lt Konfigurationen und Regeln bez√ºglich des
Verzeichnisses. Die htaccess Datei wird bei jeder Anfrage an den Server
ausgewertet und angewandt.</p>
<p>Probieren Sie die Webshell noch einmal √ºber den Browser
aufzurufen.</p>
<p>Der Inhalt der Datei verhindert das Ausf√ºhren von .ph* (PHP) Dateien
in dem Verzeichnis.</p></li>
<li><p><strong>Ma√ünahme</strong></p>
<p>Eine unkontrollierte Dateiupload Funktion kann wie Sie in den
vorherigen Schritten gesehen haben, unkontrollierte Auswirkungen haben.
Deshalb werden Sie in diesem Schritt eine Dateiupload Validierung
einf√ºgen.</p>
<p>Lokalisieren Sie hierf√ºr die Datei <strong>upload.php</strong> im
Verzeichnis <strong>/var/www/html/php.</strong></p>
<p>Bearbeiten Sie diese Datei mit <strong>nano.</strong></p>
<p>Lokalisieren Sie die Zeilen:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>uploadUnSanitized(<span class="va">$fileStorage</span><span class="ot">,</span> <span class="va">$fileName</span><span class="ot">,</span> <span class="va">$tmpFileName</span>)<span class="ot">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">// uploadSanitized($fileStorage, $fileName, $tmpFileName);</span></span></code></pre></div>
<p>Kommentieren Sie die Funktion</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>uploadUnSanitized(<span class="va">$fileStorage</span><span class="ot">,</span> <span class="va">$fileName</span><span class="ot">,</span> <span class="va">$tmpFileName</span>)<span class="ot">;</span></span></code></pre></div>
<p>aus und die Funktion</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>uploadSanitized(<span class="va">$fileStorage</span><span class="ot">,</span> <span class="va">$fileName</span><span class="ot">,</span> <span class="va">$tmpFileName</span>)<span class="ot">;</span></span></code></pre></div>
<p>ein (<strong>‚Äú//‚Äù</strong> vor der Funktion entfernen/setzten).</p>
<p>In der uploadSanitized()-Funktion wird der mimeType (Dateityp z.B.
image/jpeg), welcher √ºber die HTTP-Anfrage gesetzt wird, gepr√ºft und
validiert. Bei erfolgreicher Validierung (Dateityp ist ein Bildformat)
wird der Dateiname und Dateiendung neu gesetzt und anschlie√üend wird die
Datei abgespeichert.</p>
<p>Der Webserver antwortet mit einem <strong>HTTP 200 OK</strong> beim
erfolgreichen hochladen einer validen Datei und ein <strong>HTTP 400 Bad
Request</strong> beim Hochladen einer nicht validen Bilddatei.</p>
<p>L√∂schen Sie nun die von Ihnen hochgeladene Webshell und linpeas.sh
Skript.</p>
<p>Die Sicherheitsl√ºcke ist f√ºr den Anwendungsfall dieser √úbung
gestoppt.</p></li>
</ol>
<h3 id="erneuter-angriffsversuch"><strong>Erneuter
Angriffsversuch</strong></h3>
<p>üòà <strong>(Perspektive: Angreifer/-in)</strong></p>
<p>Probieren Sie die Webshell noch einmal √ºber den Browser
hochzuladen.</p>
<p>Der Webserver sollte Ihnen das hochladen einer nicht validen Datei
verwehren.</p>
<p><strong>Sie haben nun das Ende der √úbung erreicht.</strong> üéä</p>
<h3 id="behebung-der-sicherheitsl√ºcke-1">Behebung der
Sicherheitsl√ºcke</h3>
<p>üõ†Ô∏è <strong>(Perspektive: Serveradministrator/-in)</strong></p>
<p>Im finalen Schritt dieser √úbung wechseln Sie in die Rolle eines/r
Serveradministrator/-in.</p>
<p>Wichtig ist es, dass die hier gezeigten Ma√ünahmen unvollst√§ndig sind
um einen ausreichenden Schutz gegen√ºber dieser Sicherheitsl√ºcke zu
gew√§hren. Die Ma√ünahmen sind jedoch ausreichend f√ºr den Anwendungsfall
dieser √úbung.</p>
<ol type="1">
<li><p><strong>Ma√ünahme</strong></p>
<p>Erstellen Sie eine .htaccess Datei mit unten angef√ºhrtem Inhalt</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nano</span> /var/www/html/public/uploads/images/.htaccess</span></code></pre></div>
<p>Inhalt der .htaccess Datei:</p>
<pre><code>RemoveHandler .php .phtml .php3
RemoveType .php .phtml .php3
php_flag engine off</code></pre>
<p>Die htaccess Datei ist eine Konfigurationsdatei f√ºr einen Apache
Server. Sie enth√§lt Konfigurationen und Regeln bez√ºglich des
Verzeichnisses. Die htaccess Datei wird bei jeder Anfrage an den Server
ausgewertet und angewandt.</p>
<p>Probieren Sie die Webshell noch einmal √ºber den Browser
aufzurufen.</p>
<p>Der Inhalt der Datei verhindert das Ausf√ºhren von .ph* (PHP) Dateien
in dem Verzeichnis.</p></li>
<li><p><strong>Ma√ünahme</strong></p>
<p>Eine unkontrollierte Dateiupload Funktion kann wie Sie in den
vorherigen Schritten gesehen haben, unkontrollierte Auswirkungen haben.
Deshalb werden Sie in diesem Schritt eine Dateiupload Validierung
einf√ºgen.</p>
<p>Lokalisieren Sie hierf√ºr die Datei <strong>upload.php</strong> im
Verzeichnis <strong>/var/www/html/php.</strong></p>
<p>Bearbeiten Sie diese Datei mit <strong>nano.</strong></p>
<p>Lokalisieren Sie die Zeilen:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>uploadUnSanitized(<span class="va">$fileStorage</span><span class="ot">,</span> <span class="va">$fileName</span><span class="ot">,</span> <span class="va">$tmpFileName</span>)<span class="ot">;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">// uploadSanitized($fileStorage, $fileName, $tmpFileName);</span></span></code></pre></div>
<p>Kommentieren Sie die Funktion</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>uploadUnSanitized(<span class="va">$fileStorage</span><span class="ot">,</span> <span class="va">$fileName</span><span class="ot">,</span> <span class="va">$tmpFileName</span>)<span class="ot">;</span></span></code></pre></div>
<p>aus und die Funktion</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode php"><code class="sourceCode php"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>uploadSanitized(<span class="va">$fileStorage</span><span class="ot">,</span> <span class="va">$fileName</span><span class="ot">,</span> <span class="va">$tmpFileName</span>)<span class="ot">;</span></span></code></pre></div>
<p>ein (<strong>‚Äú//‚Äù</strong> vor der Funktion entfernen/setzten).</p>
<p>In der uploadSanitized()-Funktion wird der mimeType (Dateityp z.B.
image/jpeg), welcher √ºber die HTTP-Anfrage gesetzt wird, gepr√ºft und
validiert. Bei erfolgreicher Validierung (Dateityp ist ein Bildformat)
wird der Dateiname und Dateiendung neu gesetzt und anschlie√üend wird die
Datei abgespeichert.</p>
<p>Der Webserver antwortet mit einem <strong>HTTP 200 OK</strong> beim
erfolgreichen hochladen einer validen Datei und ein <strong>HTTP 400 Bad
Request</strong> beim Hochladen einer nicht validen Bilddatei.</p>
<p>L√∂schen Sie nun die von Ihnen hochgeladene Webshell und linpeas.sh
Skript.</p>
<p>Die Sicherheitsl√ºcke ist f√ºr den Anwendungsfall dieser √úbung
gestoppt.</p></li>
</ol>
<h3 id="erneuter-angriffsversuch-1"><strong>Erneuter
Angriffsversuch</strong></h3>
<p>üòà <strong>(Perspektive: Angreifer/-in)</strong></p>
<p>Probieren Sie die Webshell noch einmal √ºber den Browser
hochzuladen.</p>
<p>Der Webserver sollte Ihnen das hochladen einer nicht validen Datei
verwehren.</p>
<p><strong>Sie haben nun das Ende der √úbung erreicht.</strong> üéä</p>
